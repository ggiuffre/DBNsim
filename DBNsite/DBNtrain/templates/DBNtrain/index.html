{% load static %}
<link rel="stylesheet" type="text/css" href="{% static 'main.css' %}">
<script type="text/javascript" src="{% static 'highcharts.js' %}"></script>
<script type="text/javascript" src="{% static 'jquery.js' %}"></script>

<h1>Train a DBN</h1>

<form action="{% url 'train' %}" method="post" id="train_form">
	{% csrf_token %}

	<fieldset>
		<legend>Dataset info</legend>
		<select name="dataset">
			{% for s in datasets %}
				<option value="{{s}}">{{s}}</option>
			{% endfor %}
		</select>
		<label for="dataset">training dataset</label>
	</fieldset>

	<fieldset>
		<legend>Network info</legend>
		<input type="text" name="hid_sz" id="hid_sz" />
		<label for="hid_sz">number of hidden units</label>
	</fieldset>

	<fieldset>
		<legend>Training parameters</legend>
		<input type="text" name="epochs" id="epochs" value="{{config.max_epochs}}" />
		<label for="epochs">max n. of epochs</label><br />

		<input type="text" name="batch_size" id="batch_size" value="{{config.batch_size}}" />
		<label for="batch_size">size of a mini-batch</label><br />

		<input type="text" name="learn_rate" id="learn_rate" value="{{config.learn_rate}}" />
		<label for="learn_rate">learning rate</label><br />

		<input type="text" name="momentum" id="momentum" value="{{config.momentum}}" />
		<label for="momentum">momentum</label><br />

		<input type="text" name="w_decay" id="w_decay" value="{{config.w_decay}}" />
		<label for="w_decay">weight decay factor</label><br />

		<input type="text" name="threshold" id="threshold" value="{{config.threshold}}" />
		<label for="threshold">target error threshold</label>
	</fieldset>

	<button onclick="newTraining()">Train</button>
	{# <input type="submit" value="Train" /> #}
</form>

<script type="text/javascript">
	var job_id = undefined;

	function newTraining() {
		$("#train_form").submit(function(e) {
			$.ajax({
				type: 'POST',
				url: '{% url "train" %}',
				data: $('#train_form').serialize(),
				success: function(response) { job_id = response; }
			});
			setupChart();
			e.preventDefault(); // do not submit the form
		});
	}
</script>

<div id="container"></div> {# style="width:400px; height:300px" #}

<button onclick="updateError()">Step &gt;</button>

<script type="text/javascript">
	var chart;
	var index = 0;

	function setupChart() {
		chart = Highcharts.chart({
			chart: {
				renderTo: 'container',
				defaultSeriesType: 'areaspline',
				animation: {
					duration: 200
				}
			},
			title: {
				text: 'Training error over time'
			},
			xAxis: {
				min: 0,
				title: {
					text: 'Epoch number'
				},
				tickPixelInterval: 100,
				maxZoom: 20
			},
			yAxis: {
				min: 0,
				minPadding: 0.2,
				maxPadding: 0.2,
				title: {
					text: 'Error',
					margin: 80
				}
			},
			series: [{
				name: 'Training error',
				data: []
			}]
		});
	}

	function updateError(autoContinue = false) {
		var parameters = { 'job_id': job_id };
		$.ajax({
			type: 'POST',
			url: '{% url "getError" %}',
			data: JSON.stringify(parameters),
			contentType: 'application/json; charset=utf-8',
			dataType: 'json',
			success: function(response) {
				if (!response.stop) {
					var point = response.error;

					var shift = chart.series[0].data.length > 20; // shift if the series is longer than 20
					chart.series[0].addPoint([index, point], true);
					index++;

					if (autoContinue)
						setTimeout(updateError, 500); // call it again
				}
			}
		});
	}
</script>
